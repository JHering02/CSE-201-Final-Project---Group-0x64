<!DOCTYPE html>
<head>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="css/stylesheet.css" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script src="js/calendar.js"></script>
  <title>Class Track</title>
</head>
<body>
  <div>
    <script>
      window.calendarName = sessionStorage.getItem("calendarName");
      (async () => {
        const calendarObj = await getCalendar(window.calendarName);
        const events = calendarObj.Events;
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];
        for (let i = 0; i < events.length; i++) {
          const event = events[i];
          const days = event.days.split(" ");
          for (let j = 0; j < days.length; j++) {
            const day = days[j];
            const startTime = event.startTime;
            const endTime = event.endTime;
            const startHour = startTime.split(":")[0];
            const endHour = endTime.split(":")[0];
            const startMin = startTime.split(":")[1];
            const endMin = endTime.split(":")[1];
            const start = parseInt(startHour + startMin);
            const end = parseInt(endHour + endMin);
            const duration = end - start;
            const dayDiv = document.getElementsByClassName(day)[0];
            const eventDiv = document.createElement("div");
            eventDiv.className = "event";
            eventDiv.style.height = duration * 2 + "px";
            eventDiv.style.top = (start - 800) * 2 + "px";
            eventDiv.innerHTML = event.eventName;
            dayDiv.appendChild(eventDiv);
          }
        }
      })();
    </script>
  </div>
  <nav class="navbar">
    <a class="navbar-brand">Class Track</a>
    <form class="form-inline">
      <button
        id="addEvent"
        type="button"
        class="btn btn-primary"
        action=""
        onclick="openAddEvent()"
      >
        Add Event
      </button>
    </form>
  </nav>
  <!--pop up for inputs -->
  <div id="myPopup" class="popup">
    <div class="popuptext" id="popupContent">
      <h3>Add Event</h3>
      <button
        id="Close"
        type="button"
        class="btn btn-primary"
        action=""
        onclick="closePopup()"
      >
        X
      </button>
      <form name="eventInfo" onSubmit="return validateForm()">
        <label for="eventName">Event Name:</label>
        <input
          type="text"
          id="eventName"
          name="eventName"
          required
        /><br /><br />
        <label for="startDate-s">Start Date:</label><br />
        <!--A wrapped up of the time and date.-->
        <div class="weekday">
          <input
            type="checkbox"
            id="monday"
            name="startDate-s"
            value="monday"
          />
          <label for="monday">Monday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="tuesday"
            name="startDate-s"
            value="tuesday"
          />
          <label for="tuesday">Tuesday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="wednesday"
            name="startDate-s"
            value="wednesday"
          />
          <label for="wednesday">Wednesday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="thursday"
            name="startDate-s"
            value="thursday"
          />
          <label for="thursday">Thursday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="friday"
            name="startDate-s"
            value="friday"
          />
          <label for="friday">Friday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="saturday"
            name="startDate-s"
            value="saturday"
          />
          <label for="saturday">Saturday</label>
        </div>

        <div class="weekday">
          <input
            type="checkbox"
            id="sunday"
            name="startDate-s"
            value="sunday"
          />
          <label for="sunday">Sunday</label>
        </div>

        <div>
          <label for="sTime"></label>
          <input type="time" id="sTime" min="08:00" max="18:00" required />
        </div>

        <div>
          <label for="eTime"></label>
          <input type="time" id="eTime" min="08:00" max="18:00" required />
        </div>

        <label for="description">Description:</label>
        <textarea id="description" name="description"></textarea><br /><br />

        <!-- Onclick submit the form to the js functions -->
        <button
          type="button"
          class="btn btn-primary"
          id="eventInfo"
          name="eventInfo"
          onclick="validateForm()"
        >
          Add
        </button>
      </form>
    </div>
  </div>

  <!--List the dates and days -->
  <div class="float-container">
    <div class="float-child">
      <div class="green">Time</div>
    </div>
    <div class="float-child">
      <div class="green">Monday</div>
    </div>
    <div class="float-child">
      <div class="green">Tuesday</div>
    </div>
    <div class="float-child">
      <div class="green">Wednesday</div>
    </div>
    <div class="float-child">
      <div class="green">Thursday</div>
    </div>
    <div class="float-child">
      <div class="green">Friday</div>
    </div>
    <div class="float-child">
      <div class="green">Saturday</div>
    </div>
    <div class="float-child">
      <div class="green">Sunday</div>
    </div>
  </div>
  <!-- Seven boxes for the events-->
  <div class="float-container">
    <div class="float-child events">
      <div class="time" id="8am">8:00</div>
      <div class="time" id="9am">9:00</div>
      <div class="time" id="10am">10:00</div>
      <div class="time" id="11am">11:00</div>
      <div class="time" id="12pm">12:00</div>
      <div class="time" id="1pm">13:00</div>
      <div class="time" id="2pm">14:00</div>
      <div class="time" id="3pm">15:00</div>
      <div class="time" id="4pm">16:00</div>
      <div class="time" id="5pm">17:00</div>
      <div class="time" id="6pm">18:00</div>
      <div class="time" id="7pm">19:00</div>
      <div class="time" id="8pm">20:00</div>
    </div>
    <div class="float-child events">
      <div class="day monday"></div>
    </div>
    <div class="float-child events">
      <div class="day tuesday"></div>
    </div>
    <div class="float-child events">
      <div class="day wednesday"></div>
    </div>
    <div class="float-child events">
      <div class="day thursday"></div>
    </div>
    <div class="float-child events">
      <div class="day friday"></div>
    </div>
    <div class="float-child events">
      <div class="day saturday"></div>
    </div>
    <div class="float-child events">
      <div class="day sunday"></div>
    </div>
  </div>
</body>
<script>
  function openAddEvent() {
    var add_event = document.getElementById("myPopup");
    if (add_event.style.display === "none" || add_event.style.display === "") {
      add_event.style.display = "block";
    } else {
      add_event.style.display = "none";
    }
  }

  function closePopup() {
    document.getElementById("myPopup").style.display = "none";
  }

  function toggleTimeInput(checkboxId, startTimeId, endTimeId) {
    var checkbox = document.getElementById(checkboxId);
    var startTime = document.getElementById(startTimeId);
    var endTime = document.getElementById(endTimeId);

    // If the checkbox is checked, display the time inputs
    if (checkbox.checked) {
      startTime.style.display = "block";
      endTime.style.display = "block";
    } else {
      // If the checkbox is not checked, hide the time inputs
      startTime.style.display = "none";
      endTime.style.display = "none";
    }
  }

  async function validateForm() {
    // Check if the event name is provided
    var eventName = document.getElementById("eventName").value;
    if (!eventName.trim()) {
      alert("Please enter an event name.");
      return false;
    }

    // Check for at least one selected weekday and corresponding time inputs
    var weekdays = [
      "monday",
      "tuesday",
      "wednesday",
      "thursday",
      "friday",
      "saturday",
      "sunday",
    ];
    var atLeastOneDayChecked = false;

    for (var i = 0; i < weekdays.length; i++) {
      var checkbox = document.getElementById(weekdays[i]);
      var startTime = document.getElementById("sTime");
      var endTime = document.getElementById("eTime");

      if (checkbox.checked) {
        atLeastOneDayChecked = true;

        // Check if corresponding time inputs are provided
        if (!startTime.value || !endTime.value) {
          alert("Please enter start and end time for " + weekdays[i]);
          return;
        }
        var start = startTime.value;
        var end = endTime.value;
        if (start >= end) {
          alert(
            "The start time must be earlier than the end time for " +
              weekdays[i]
          );
          return;
        }
        if (!isTimeInRange(start) || !isTimeInRange(end)) {
          alert(
            "Start and end times must be between 8:00 AM and 8:00 PM for " +
              weekdays[i]
          );
          return;
        }
      }
    }

    if (!atLeastOneDayChecked) {
      alert("Please select at least one weekday.");
      return;
    }
    // make an event on the calendar if the form is valid
    days = "";
    for (var i = 0; i < weekdays.length; i++) {
      var checkbox = document.getElementById(weekdays[i]);
      if (checkbox.checked) {
        days += weekdays[i] + " ";
      }
    }

    var passST = new Date("1970-01-01T" + startTime.value + ":00");
    var passET = new Date("1970-01-01T" + endTime.value + ":00");
    await makeEvent(
      eventName,
      description.value,
      passST,
      passET,
      days,
      window.calendarName
    );
    // Refresh the page to show the new event
    location.reload();
  }
  function isTimeInRange(timeStr) {
    var time = parseInt(timeStr.replace(":", ""), 10);
    return time >= 800 && time <= 2000;
  }
</script>
